Description: Support builds without XKB V2 support (1.11.0)
Author: Richart Ayotte <rich@ayottesoftware.com>

Index: source/src/devices/IKeyboard.cpp
===================================================================
--- source.orig/src/devices/IKeyboard.cpp
+++ source/src/devices/IKeyboard.cpp
@@ -87,13 +87,22 @@ void IKeyboard::setKeymap(const SStringR
         if (FILE* const KEYMAPFILE = fopen(path.c_str(), "r"); !KEYMAPFILE)
             Debug::log(ERR, "Cannot open input:kb_file= file for reading");
         else {
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
             m_xkbKeymap = xkb_keymap_new_from_file(CONTEXT, KEYMAPFILE, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#else
+            m_xkbKeymap = xkb_keymap_new_from_file(CONTEXT, KEYMAPFILE, XKB_KEYMAP_FORMAT_TEXT_V1, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#endif
             fclose(KEYMAPFILE);
         }
     }
 
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
     if (!m_xkbKeymap)
         m_xkbKeymap = xkb_keymap_new_from_names2(CONTEXT, &XKBRULES, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#else
+    if (!m_xkbKeymap)
+        m_xkbKeymap = xkb_keymap_new_from_names(CONTEXT, &XKBRULES, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#endif
 
     if (!m_xkbKeymap) {
         g_pConfigManager->addParseError("Invalid keyboard layout passed. ( rules: " + rules.rules + ", model: " + rules.model + ", variant: " + rules.variant +
@@ -109,7 +118,11 @@ void IKeyboard::setKeymap(const SStringR
         m_currentRules.options = "";
         m_currentRules.layout  = "us";
 
-        m_xkbKeymap = xkb_keymap_new_from_names2(CONTEXT, &XKBRULES, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
+         m_xkbKeymap = xkb_keymap_new_from_names2(CONTEXT, &XKBRULES, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#else
+         m_xkbKeymap = xkb_keymap_new_from_names(CONTEXT, &XKBRULES, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#endif
     }
 
     updateXKBTranslationState(m_xkbKeymap);
@@ -153,7 +166,11 @@ void IKeyboard::updateKeymapFD() {
     if (m_xkbKeymapV1FD.isValid())
         m_xkbKeymapV1FD.reset();
 
-    auto cKeymapStr   = xkb_keymap_get_as_string(m_xkbKeymap, XKB_KEYMAP_FORMAT_TEXT_V2);
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
+    auto cKeymapStr = xkb_keymap_get_as_string(m_xkbKeymap, XKB_KEYMAP_FORMAT_TEXT_V2);
+#else
+    auto cKeymapStr = xkb_keymap_get_as_string(m_xkbKeymap, XKB_KEYMAP_FORMAT_TEXT_V1);
+#endif
     m_xkbKeymapString = cKeymapStr;
     free(cKeymapStr); // NOLINT(cppcoreguidelines-no-malloc,-warnings-as-errors)
     auto cKeymapV1Str   = xkb_keymap_get_as_string(m_xkbKeymap, XKB_KEYMAP_FORMAT_TEXT_V1);
@@ -238,19 +255,31 @@ void IKeyboard::updateXKBTranslationStat
             rules.model   = model.c_str();
             rules.variant = variant.c_str();
 
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
             auto KEYMAP = xkb_keymap_new_from_names2(PCONTEXT, &rules, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#else
+            auto KEYMAP = xkb_keymap_new_from_names(PCONTEXT, &rules, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#endif
 
             if (!KEYMAP) {
                 Debug::log(ERR, "updateXKBTranslationState: keymap failed 1, fallback without model/variant");
                 rules.model   = "";
                 rules.variant = "";
-                KEYMAP        = xkb_keymap_new_from_names2(PCONTEXT, &rules, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
+                KEYMAP = xkb_keymap_new_from_names2(PCONTEXT, &rules, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#else
+                KEYMAP = xkb_keymap_new_from_names(PCONTEXT, &rules, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#endif
             }
 
             if (!KEYMAP) {
                 Debug::log(ERR, "updateXKBTranslationState: keymap failed 2, fallback to us");
                 rules.layout = "us";
-                KEYMAP       = xkb_keymap_new_from_names2(PCONTEXT, &rules, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
+                KEYMAP = xkb_keymap_new_from_names2(PCONTEXT, &rules, XKB_KEYMAP_FORMAT_text_v2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#else
+                KEYMAP = xkb_keymap_new_from_names(PCONTEXT, &rules, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#endif
             }
 
             m_xkbState       = xkb_state_new(KEYMAP);
@@ -274,7 +303,11 @@ void IKeyboard::updateXKBTranslationStat
         .options = m_currentRules.options.c_str(),
     };
 
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
     const auto NEWKEYMAP = xkb_keymap_new_from_names2(PCONTEXT, &rules, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#else
+    const auto NEWKEYMAP = xkb_keymap_new_from_names(PCONTEXT, &rules, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#endif
 
     m_xkbState       = xkb_state_new(NEWKEYMAP);
     m_xkbStaticState = xkb_state_new(NEWKEYMAP);
Index: source/src/managers/KeybindManager.cpp
===================================================================
--- source.orig/src/managers/KeybindManager.cpp
+++ source/src/managers/KeybindManager.cpp
@@ -296,8 +296,13 @@ void CKeybindManager::updateXKBTranslati
     const auto        PCONTEXT   = xkb_context_new(XKB_CONTEXT_NO_FLAGS);
     FILE* const       KEYMAPFILE = FILEPATH.empty() ? nullptr : fopen(absolutePath(FILEPATH, g_pConfigManager->m_configCurrentPath).c_str(), "r");
 
-    auto              PKEYMAP = KEYMAPFILE ? xkb_keymap_new_from_file(PCONTEXT, KEYMAPFILE, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS) :
-                                             xkb_keymap_new_from_names2(PCONTEXT, &rules, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
+    auto PKEYMAP = KEYMAPFILE ? xkb_keymap_new_from_file(PCONTEXT, KEYMAPFILE, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS) :
+                                xkb_keymap_new_from_names2(PCONTEXT, &rules, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#else
+    auto PKEYMAP = KEYMAPFILE ? xkb_keymap_new_from_file(PCONTEXT, KEYMAPFILE, XKB_KEYMAP_FORMAT_TEXT_V1, XKB_KEYMAP_COMPILE_NO_FLAGS) :
+                                xkb_keymap_new_from_names(PCONTEXT, &rules, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#endif
     if (KEYMAPFILE)
         fclose(KEYMAPFILE);
 
@@ -310,7 +315,11 @@ void CKeybindManager::updateXKBTranslati
                    rules.rules, rules.model, rules.options);
         memset(&rules, 0, sizeof(rules));
 
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
         PKEYMAP = xkb_keymap_new_from_names2(PCONTEXT, &rules, XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#else
+        PKEYMAP = xkb_keymap_new_from_names(PCONTEXT, &rules, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#endif
     }
 
     xkb_context_unref(PCONTEXT);
Index: source/src/protocols/VirtualKeyboard.cpp
===================================================================
--- source.orig/src/protocols/VirtualKeyboard.cpp
+++ source/src/protocols/VirtualKeyboard.cpp
@@ -88,7 +88,11 @@ CVirtualKeyboardV1Resource::CVirtualKeyb
             return;
         }
 
+#ifdef XKB_KEYMAP_FORMAT_TEXT_V2
         auto xkbKeymap = xkb_keymap_new_from_string(xkbContext, sc<const char*>(keymapData), XKB_KEYMAP_FORMAT_TEXT_V2, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#else
+        auto xkbKeymap = xkb_keymap_new_from_string(xkbContext, sc<const char*>(keymapData), XKB_KEYMAP_FORMAT_TEXT_V1, XKB_KEYMAP_COMPILE_NO_FLAGS);
+#endif
         munmap(keymapData, len);
 
         if UNLIKELY (!xkbKeymap) {
Index: source/CMakeLists.txt
===================================================================
--- source.orig/CMakeLists.txt
+++ source/CMakeLists.txt
@@ -197,7 +197,7 @@ pkg_check_modules(
   deps
   REQUIRED
   IMPORTED_TARGET
-  xkbcommon>=1.11.0
+  xkbcommon
   uuid
   wayland-server
   wayland-protocols>=1.45
